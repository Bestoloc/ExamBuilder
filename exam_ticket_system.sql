

-- Таблица предметов
CREATE TABLE subjects (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL UNIQUE,
    description TEXT
);

-- Таблица тем
CREATE TABLE topics (
    id SERIAL PRIMARY KEY,
    subject_id INTEGER REFERENCES subjects(id) ON DELETE CASCADE,
    name VARCHAR(100) NOT NULL,
    description TEXT
);

-- Таблица преподавателей
CREATE TABLE teachers (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    password VARCHAR(100) NOT NULL,
    full_name VARCHAR(100) NOT NULL,
    email VARCHAR(100)
);

-- Таблица студентов
CREATE TABLE students (
    id SERIAL PRIMARY KEY,
    group_name VARCHAR(50) NOT NULL,
    full_name VARCHAR(100) NOT NULL,
    student_code VARCHAR(20) UNIQUE
);

-- Таблица вопросов
CREATE TABLE questions (
    id SERIAL PRIMARY KEY,
    subject_id INTEGER REFERENCES subjects(id) ON DELETE CASCADE,
    topic_id INTEGER REFERENCES topics(id) ON DELETE CASCADE,
    text TEXT NOT NULL,
    type VARCHAR(50) NOT NULL,
    difficulty INTEGER CHECK (difficulty BETWEEN 1 AND 3),
    answer TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by INTEGER REFERENCES teachers(id)
);

-- Таблица билетов
CREATE TABLE tickets (
    id SERIAL PRIMARY KEY,
    subject_id INTEGER REFERENCES subjects(id) ON DELETE CASCADE,
    number INTEGER NOT NULL,
    name VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by INTEGER REFERENCES teachers(id),
    UNIQUE(subject_id, number)
);

-- Таблица вопросов в билетах
CREATE TABLE ticket_questions (
    id SERIAL PRIMARY KEY,
    ticket_id INTEGER REFERENCES tickets(id) ON DELETE CASCADE,
    question_id INTEGER REFERENCES questions(id) ON DELETE CASCADE,
    order_num INTEGER NOT NULL,
    UNIQUE(ticket_id, question_id)
);

-- Таблица использования билетов
CREATE TABLE usages (
    id SERIAL PRIMARY KEY,
    ticket_id INTEGER REFERENCES tickets(id) ON DELETE CASCADE,
    student_id INTEGER REFERENCES students(id) ON DELETE CASCADE,
    usage_date DATE NOT NULL,
    group_name VARCHAR(50) NOT NULL,
    avg_score NUMERIC(4,2) CHECK (avg_score BETWEEN 0 AND 100),
    teacher_comment TEXT,
    assessed_by INTEGER REFERENCES teachers(id),
    assessed_at TIMESTAMP
);

-- Таблица оценок по вопросам
CREATE TABLE question_scores (
    id SERIAL PRIMARY KEY,
    usage_id INTEGER REFERENCES usages(id) ON DELETE CASCADE,
    question_id INTEGER REFERENCES questions(id) ON DELETE CASCADE,
    score NUMERIC(4,2) CHECK (score BETWEEN 0 AND 100),
    comment TEXT
);

-- Вставка начальных данных
INSERT INTO subjects (name, description) VALUES 
('Математика', 'Основы математики и алгебры'),
('Физика', 'Основы физики и механики'),
('Информатика', 'Программирование и алгоритмы');

INSERT INTO teachers (username, password, full_name, email) VALUES
('1', '1', 'Иванов Иван Иванович', 'teacher1@university.edu'),
('teacher2', 'password456', 'Петрова Мария Сергеевна', 'teacher2@university.edu');

INSERT INTO students (group_name, full_name, student_code) VALUES
('Группа 101', 'Сидоров Алексей Петрович', 'S001'),
('Группа 101', 'Козлова Анна Владимировна', 'S002'),
('Группа 102', 'Михайлов Дмитрий Сергеевич', 'S003'),
('Группа 102', 'Новикова Екатерина Алексеевна', 'S004'),
('Группа 101', 'Васильев Игорь Николаевич', 'S005'),
('Группа 101', 'Смирнова Ольга Дмитриевна', 'S006'),
('Группа 102', 'Федоров Павел Андреевич', 'S007'),
('Группа 102', 'Орлова Татьяна Викторовна', 'S008'),
('Группа 103', 'Белов Александр Сергеевич', 'S009'),
('Группа 103', 'Крылова Юлия Игоревна', 'S010'),
('Группа 201', 'Громов Михаил Васильевич', 'S011'),
('Группа 201', 'Зайцева Елена Петровна', 'S012'),
('Группа 202', 'Тихонов Сергей Александрович', 'S013'),
('Группа 202', 'Воробьева Наталья Сергеевна', 'S014');

INSERT INTO topics (subject_id, name, description) VALUES
(1, 'Алгебра', 'Линейные уравнения и матрицы'),
(1, 'Геометрия', 'Планиметрия и стереометрия'),
(2, 'Механика', 'Законы Ньютона'),
(3, 'Программирование', 'Основы программирования на Java'),
(1, 'Математический анализ', 'Дифференциальное и интегральное исчисление'),
(1, 'Теория вероятностей', 'Основы теории вероятностей и статистики'),
(2, 'Электричество и магнетизм', 'Электростатика и электродинамика'),
(2, 'Оптика', 'Геометрическая и волновая оптика'),
(3, 'Базы данных', 'Реляционные базы данных и SQL'),
(3, 'Алгоритмы и структуры данных', 'Сортировка, поиск, деревья, графы');

-- 3. ВОПРОСЫ ДЛЯ ТЕМЫ "Алгебра" (все три уровня сложности)
INSERT INTO questions (subject_id, topic_id, text, type, difficulty, answer, created_by) VALUES
-- Легкие вопросы (difficulty = 1)
(1, 1, 'Решите уравнение: x + 3 = 7', 'открытый', 1, 'x = 4', 1),
(1, 1, 'Найдите значение выражения: 2 × (3 + 5)', 'открытый', 1, '16', 1),
(1, 1, 'Что такое натуральное число?', 'теоретический', 1, 'Целое положительное число (1, 2, 3, ...)', 1),

-- Средние вопросы (difficulty = 2) - уже есть 3
(1, 1, 'Решите систему уравнений: x + y = 5, x - y = 1', 'открытый', 2, 'x = 3, y = 2', 1),
(1, 1, 'Разложите на множители: x² - 4', 'открытый', 2, '(x - 2)(x + 2)', 1),
(1, 1, 'Объясните понятие модуля числа', 'теоретический', 2, 'Расстояние от числа до нуля на числовой прямой', 1),

-- Сложные вопросы (difficulty = 3)
(1, 1, 'Решите уравнение: x³ - 6x² + 11x - 6 = 0', 'открытый', 3, 'x₁ = 1, x₂ = 2, x₃ = 3', 1),
(1, 1, 'Докажите основную теорему алгебры', 'теоретический', 3, 'Любой многочлен степени n имеет ровно n комплексных корней с учетом кратности', 1),
(1, 1, 'Решите неравенство: (x-1)/(x+2) > 0', 'открытый', 3, 'x ∈ (-∞, -2) ∪ (1, ∞)', 1);

-- 4. ВОПРОСЫ ДЛЯ ТЕМЫ "Геометрия" (все три уровня сложности)
INSERT INTO questions (subject_id, topic_id, text, type, difficulty, answer, created_by) VALUES
-- Легкие вопросы
(1, 2, 'Сколько градусов в прямом угле?', 'открытый', 1, '90°', 1),
(1, 2, 'Чему равен периметр квадрата со стороной 5 см?', 'открытый', 1, '20 см', 1),
(1, 2, 'Что такое радиус окружности?', 'теоретический', 1, 'Расстояние от центра окружности до любой точки на ней', 1),

-- Средние вопросы - уже есть 3
(1, 2, 'Найдите площадь круга радиусом 7 см (π ≈ 3.14)', 'открытый', 2, '153.86 см²', 1),
(1, 2, 'В прямоугольном треугольнике гипотенуза 10 см, один катет 6 см. Найдите другой катет.', 'открытый', 2, '8 см', 1),
(1, 2, 'Объясните понятие подобных треугольников', 'теоретический', 2, 'Треугольники, у которых соответствующие углы равны, а стороны пропорциональны', 1),

-- Сложные вопросы
(1, 2, 'В треугольнике ABC: AB=8, BC=6, AC=7. Найдите площадь треугольника.', 'открытый', 3, 'Использовать формулу Герона: S ≈ 20.33', 1),
(1, 2, 'Докажите теорему синусов', 'теоретический', 3, 'a/sinA = b/sinB = c/sinC = 2R', 1),
(1, 2, 'В правильной четырехугольной пирамиде сторона основания 6 см, высота 8 см. Найдите объем.', 'открытый', 3, 'V = 96 см³', 1);

-- 5. ВОПРОСЫ ДЛЯ ТЕМЫ "Механика" (все три уровня сложности)
INSERT INTO questions (subject_id, topic_id, text, type, difficulty, answer, created_by) VALUES
-- Легкие вопросы
(2, 3, 'Что такое скорость?', 'открытый', 1, 'Векторная величина, характеризующая быстроту перемещения', 1),
(2, 3, 'Рассчитайте путь при равномерном движении со скоростью 5 м/с за 3 секунды', 'открытый', 1, '15 метров', 1),
(2, 3, 'Что такое инерция?', 'теоретический', 1, 'Свойство тела сохранять состояние покоя или равномерного прямолинейного движения', 1),

-- Средние вопросы - уже есть 3
(2, 3, 'Тело массой 2 кг движется с ускорением 3 м/с². Найдите действующую силу.', 'открытый', 2, 'F = ma = 6 Н', 1),
(2, 3, 'Рассчитайте кинетическую энергию тела массой 4 кг, движущегося со скоростью 5 м/с', 'открытый', 2, 'Eк = mv²/2 = 50 Дж', 1),
(2, 3, 'Объясните закон сохранения энергии в механике', 'теоретический', 2, 'Полная механическая энергия замкнутой системы сохраняется', 1),

-- Сложные вопросы
(2, 3, 'Тело брошено под углом 30° к горизонту со скоростью 20 м/с. Найдите максимальную высоту подъема.', 'открытый', 3, 'H = v₀²sin²α/(2g) ≈ 5.1 м', 1),
(2, 3, 'Выведите формулу для периода математического маятника', 'теоретический', 3, 'T = 2π√(L/g)', 1),
(2, 3, 'На наклонной плоскости с углом 30° лежит тело массой 10 кг. Коэффициент трения 0.2. Найдите ускорение тела.', 'открытый', 3, 'a = g(sinα - μcosα) ≈ 3.2 м/с²', 1);

-- 6. ВОПРОСЫ ДЛЯ ТЕМЫ "Программирование" (все три уровня сложности)
INSERT INTO questions (subject_id, topic_id, text, type, difficulty, answer, created_by) VALUES
-- Легкие вопросы
(3, 4, 'Что такое переменная в программировании?', 'открытый', 1, 'Именованная область памяти для хранения данных', 1),
(3, 4, 'Напишите простой цикл for на Java для вывода чисел от 1 до 5', 'практический', 1, 'for(int i=1; i<=5; i++) System.out.println(i);', 1),
(3, 4, 'Что такое компилятор?', 'теоретический', 1, 'Программа, переводящая исходный код в машинный', 1),

-- Средние вопросы - уже есть 3
(3, 4, 'В чем разница между ArrayList и LinkedList в Java?', 'теоретический', 2, 'ArrayList - массив, быстрый доступ; LinkedList - список, быстрая вставка/удаление', 1),
(3, 4, 'Напишите рекурсивную функцию для вычисления факториала', 'практический', 2, 'int factorial(int n) { return n<=1 ? 1 : n*factorial(n-1); }', 1),
(3, 4, 'Объясните принцип инкапсуляции в ООП', 'теоретический', 2, 'Сокрытие внутренней реализации и предоставление интерфейса', 1),

-- Сложные вопросы
(3, 4, 'Реализуйте паттерн Singleton на Java с ленивой инициализацией', 'практический', 3, 'public class Singleton { private static Singleton instance; private Singleton() {} public static synchronized Singleton getInstance() { if(instance==null) instance=new Singleton(); return instance; }}', 1),
(3, 4, 'Объясните различия между абстрактным классом и интерфейсом в Java 8+', 'теоретический', 3, 'Абстрактный класс - состояние+поведение, интерфейс - только поведение (но default методы)', 1),
(3, 4, 'Напишите потокобезопасную реализацию кэша с использованием ConcurrentHashMap', 'практический', 3, 'ConcurrentHashMap<String, Object> cache = new ConcurrentHashMap<>();', 1);

-- 7. ВОПРОСЫ ДЛЯ НОВЫХ ТЕМ

-- 7.1 Тема "Математический анализ" (предмет "Математика")
INSERT INTO questions (subject_id, topic_id, text, type, difficulty, answer, created_by) VALUES
-- Легкие
(1, 5, 'Найдите производную функции: f(x) = x²', 'открытый', 1, 'f''(x) = 2x', 1),
(1, 5, 'Что такое производная функции?', 'теоретический', 1, 'Скорость изменения функции в точке', 1),
(1, 5, 'Вычислите предел: lim(x→2) (3x + 1)', 'открытый', 1, '7', 1),

-- Средние
(1, 5, 'Найдите производную: f(x) = sin(x) + cos(x)', 'открытый', 2, 'f''(x) = cos(x) - sin(x)', 1),
(1, 5, 'Вычислите интеграл: ∫(2x)dx', 'открытый', 2, 'x² + C', 1),
(1, 5, 'Объясните геометрический смысл производной', 'теоретический', 2, 'Тангенс угла наклона касательной к графику функции', 1),

-- Сложные
(1, 5, 'Найдите производную: f(x) = ln(x² + 1)', 'открытый', 3, 'f''(x) = 2x/(x² + 1)', 1),
(1, 5, 'Вычислите определенный интеграл: ∫₀¹ (x³)dx', 'открытый', 3, '1/4', 1),
(1, 5, 'Докажите правило Лопиталя', 'теоретический', 3, 'lim f(x)/g(x) = lim f''(x)/g''(x) при неопределенности 0/0 или ∞/∞', 1);

-- 7.2 Тема "Теория вероятностей" (предмет "Математика")
INSERT INTO questions (subject_id, topic_id, text, type, difficulty, answer, created_by) VALUES
-- Легкие
(1, 6, 'Какова вероятность выпадения орла при подбрасывании монеты?', 'открытый', 1, '0.5 или 50%', 1),
(1, 6, 'Что такое случайное событие?', 'теоретический', 1, 'Событие, которое может произойти или не произойти', 1),
(1, 6, 'Сколько исходов при бросании игрального кубика?', 'открытый', 1, '6', 1),

-- Средние
(1, 6, 'Вероятность события A = 0.3, события B = 0.4. Найдите P(A∩B) для независимых событий.', 'открытый', 2, '0.12', 1),
(1, 6, 'Рассчитайте математическое ожидание для кубика', 'открытый', 2, 'E = 3.5', 1),
(1, 6, 'Объясните разницу между перестановками и сочетаниями', 'теоретический', 2, 'Перестановки - порядок важен, сочетания - порядок не важен', 1),

-- Сложные
(1, 6, 'Решите задачу: из колоды 36 карт вынимают 2 карты. Найдите вероятность, что обе карты - тузы.', 'открытый', 3, 'C(4,2)/C(36,2) ≈ 0.0095', 1),
(1, 6, 'Выведите формулу для дисперсии дискретной случайной величины', 'теоретический', 3, 'D(X) = E[(X - E[X])²] = E[X²] - (E[X])²', 1),
(1, 6, 'Найдите вероятность того, что при 10 подбрасываниях монеты орел выпадет ровно 6 раз', 'открытый', 3, 'C(10,6)/2¹⁰ ≈ 0.205', 1);

-- 8. СОЗДАЕМ НЕСКОЛЬКО БИЛЕТОВ И ИХ ИСПОЛЬЗОВАНИЕ

-- 8.1 Создаем билеты
INSERT INTO tickets (subject_id, number, name, created_by) VALUES
(1, 1, 'Билет по алгебре и геометрии', 1),
(1, 2, 'Билет по математическому анализу', 1),
(2, 1, 'Билет по механике', 1),
(3, 1, 'Билет по основам программирования', 1);

-- 8.2 Добавляем вопросы в билеты (ticket_questions)
-- Для билета 1 (математика) - по 2 вопроса из каждой темы
INSERT INTO ticket_questions (ticket_id, question_id, order_num) VALUES
(1, 1, 1),  -- Решите уравнение: 2x + 5 = 15
(1, 2, 2),  -- Найдите дискриминант
(1, 13, 3), -- Чему равна сумма углов треугольника?
(1, 14, 4), -- Найдите площадь треугольника

-- Для билета 2 (математический анализ)
(2, 19, 1), -- Найдите производную: f(x) = x²
(2, 20, 2), -- Что такое производная?
(2, 22, 3), -- Найдите производную: f(x) = sin(x) + cos(x)

-- Для билета 3 (механика)
(3, 7, 1),  -- Сформулируйте первый закон Ньютона
(3, 8, 2),  -- Рассчитайте силу тяжести
(3, 10, 3), -- Что такое скорость?

-- Для билета 4 (программирование)
(4, 16, 1), -- Что такое класс в ООП?
(4, 17, 2), -- Напишите пример наследования
(4, 19, 3); -- Что такое переменная?

-- 8.3 Создаем записи об использовании билетов (usages)
INSERT INTO usages (ticket_id, student_id, usage_date, group_name, avg_score, assessed_by) VALUES
(1, 1, '2024-12-01', 'Группа 101', 85.50, 1),
(1, 2, '2024-12-01', 'Группа 101', 92.00, 1),
(1, 3, '2024-12-02', 'Группа 102', 78.25, 1),
(2, 4, '2024-12-03', 'Группа 102', 88.00, 1),
(3, 5, '2024-12-04', 'Группа 103', 76.75, 2),
(3, 6, '2024-12-04', 'Группа 103', 94.50, 2),
(4, 7, '2024-12-05', 'Группа 201', 91.00, 2),
(4, 8, '2024-12-05', 'Группа 201', 82.25, 2);

-- 8.4 Добавляем оценки по вопросам (question_scores)
-- Для использования 1 (студент 1, билет 1)
INSERT INTO question_scores (usage_id, question_id, score, comment) VALUES
(1, 1, 5.0, 'Правильно решено'),
(1, 2, 4.0, 'Мелкая ошибка в вычислениях'),
(1, 13, 5.0, 'Отличный ответ'),
(1, 14, 3.0, 'Пропущен шаг в решении'),

-- Для использования 2 (студент 2, билет 1)
(2, 1, 5.0, 'Идеальное решение'),
(2, 2, 5.0, 'Все верно'),
(2, 13, 5.0, 'Отличное знание теории'),
(2, 14, 4.0, 'Арифметическая ошибка'),

-- Для использования 3 (студент 3, билет 1)
(3, 1, 4.0, 'Неверно применена формула'),
(3, 2, 4.0, 'Хорошо, но можно лучше'),
(3, 13, 5.0, 'Правильно'),
(3, 14, 4.0, 'Не указаны единицы измерения'),

-- Для использования 4 (студент 4, билет 2)
(4, 19, 4.0, 'Правильная производная'),
(4, 20, 4.0, 'Неполное определение'),
(4, 22, 4.0, 'Есть ошибка в знаке'),

-- Для использования 7 (студент 7, билет 4)
(7, 16, 5.0, 'Хорошее понимание ООП'),
(7, 17, 5.0, 'Пример корректен, но можно добавить комментарии'),
(7, 19, 5.0, 'Правильное определение');

-- 9. ДОПОЛНИТЕЛЬНЫЕ ИНДЕКСЫ ДЛЯ УСКОРЕНИЯ
CREATE INDEX idx_ticket_questions_ticket ON ticket_questions(ticket_id);
CREATE INDEX idx_ticket_questions_question ON ticket_questions(question_id);
CREATE INDEX idx_questions_type ON questions(type);
CREATE INDEX idx_usages_group ON usages(group_name);
CREATE INDEX idx_students_group ON students(group_name);
CREATE INDEX idx_question_scores_score ON question_scores(score);

-- 10. СТАТИСТИЧЕСКИЕ ДАННЫЕ ДЛЯ ТЕСТИРОВАНИЯ АНАЛИТИКИ

-- Обновляем средние баллы в usages на основе question_scores
UPDATE usages u SET avg_score = (
    SELECT AVG(score) FROM question_scores qs WHERE qs.usage_id = u.id
) WHERE u.avg_score IS NULL;

-- Добавляем комментарии преподавателей
UPDATE usages SET teacher_comment = 'Хорошая работа, но нужно больше практики' WHERE id = 1;
UPDATE usages SET teacher_comment = 'Отличные результаты!' WHERE id = 2;
UPDATE usages SET teacher_comment = 'Требуется дополнительная подготовка' WHERE id = 3;
UPDATE usages SET teacher_comment = 'Стабильные знания по предмету' WHERE id = 4;

-- Устанавливаем даты оценивания
UPDATE usages SET assessed_at = usage_date + INTERVAL '1 day' WHERE assessed_at IS NULL;

-- Проверка итоговых данных
SELECT 'Всего студентов: ' || COUNT(*) FROM students;
SELECT 'Всего вопросов: ' || COUNT(*) FROM questions;
SELECT 'Всего билетов: ' || COUNT(*) FROM tickets;
SELECT 'Всего использований билетов: ' || COUNT(*) FROM usages;
SELECT 'Всего оценок по вопросам: ' || COUNT(*) FROM question_scores;

-- Проверка распределения вопросов по сложности
SELECT
    'Вопросы по сложности - ' ||
    'Легкие: ' || COUNT(CASE WHEN difficulty = 1 THEN 1 END) || ', ' ||
    'Средние: ' || COUNT(CASE WHEN difficulty = 2 THEN 1 END) || ', ' ||
    'Сложные: ' || COUNT(CASE WHEN difficulty = 3 THEN 1 END)
FROM questions;

-- Создание индексов для ускорения запросов
CREATE INDEX idx_questions_subject_topic ON questions(subject_id, topic_id);
CREATE INDEX idx_questions_difficulty ON questions(difficulty);
CREATE INDEX idx_usages_student_date ON usages(student_id, usage_date);
CREATE INDEX idx_usages_ticket ON usages(ticket_id);
CREATE INDEX idx_question_scores_usage ON question_scores(usage_id);